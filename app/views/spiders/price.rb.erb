<%="#encoding:utf-8"%>
require 'headless'
require 'rubygems'
require 'selenium-webdriver'
require 'yaml'
require 'json'
require 'redis'

headless = Headless.new(:reuse => false)
headless.start

$redis =  Redis.new(:host => '114.80.100.12', :port => 6379)
 
driver = Selenium::WebDriver.for :chrome
#driver.manage.timeouts.implicit_wait = 30
driver.manage.timeouts.script_timeout = 120
driver.manage.timeouts.page_load = 60



<%=raw @links%>.each do |link|
 doc = {}
 puts link[0]
 doc[:docid]=link[1]
  begin
    driver.get link[0]
    doc[:price] = driver.find_element(:xpath, "<%=raw @spider.pprice %>").text
  rescue => e  
    puts e.to_s
  end
   key = "sku_price_updated_#{link[1]}"
   $redis.set(key, doc.to_yaml)
end

driver.quit
<% unless params[:debug] %>
#`ps -ef | grep chromium-browser | grep -v grep | awk '{print $2}' | xargs kill -9`
<% end %>

headless.destroy
